<!DOCTYPE html>
<html lang="vi">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Cáº£m Æ n VÃ¬ ÄÃ£ Äáº¿n</title>
Â  Â  <style>
Â  Â  Â  Â  #admin-panel {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  background: #1a1a1a;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 3px solid #333;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  :root { --bg: #0a0a0a; --accent: #f1c40f; --card-w: 72px; --card-h: 100px; --panel-bg: #111; }
Â  Â  Â  Â  body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
Â  Â  Â  Â  #admin-panel { background: #1a1a1a; padding: 15px; border-bottom: 3px solid #333; height: auto; max-height: 90vh; overflow-y: auto; z-index: 1000; position: relative; }
Â  Â  Â  Â  .admin-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; }
Â  Â  Â  Â  .box { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
Â  Â  Â  Â  .scroll-v { height: 350px; overflow-y: auto; background: #000; padding: 8px; border-radius: 5px; scrollbar-width: thin; }
Â  Â  Â  Â  .team-item { background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 3px solid var(--accent); }
Â  Â  Â  Â  #game-screen { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; background: #050505; }
Â  Â  Â  Â  .rules-sidebar { background: var(--panel-bg); border-right: 1px solid #333; padding: 15px; overflow-y: auto; font-size: 13px; color: #ddd; line-height: 1.5; scrollbar-width: thin; }
Â  Â  Â  Â  .rules-sidebar h3 { color: var(--accent); margin-top: 0; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
Â  Â  Â  Â  .play-main { display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; justify-content: center; align-items: center; gap: 15px; }
Â  Â  Â  Â  .right-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; align-items: center; z-index: 100; }
Â  Â  Â  Â  .circle-ui { width: 70px; height: 70px; border-radius: 50%; background: #222; border: 3px solid #444; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
Â  Â  Â  Â  #timer-val { font-size: 32px; color: var(--accent); }
Â  Â  Â  Â  .timer-label { font-size: 8px; color: #888; margin-top: -5px; }
Â  Â  Â  Â  #turn-indicator { font-size: 12px; text-align: center; line-height: 1.2; }
Â  Â  Â  Â  .p-active { border-color: #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
Â  Â  Â  Â  .ai-active { border-color: #ff4757; color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }
Â  Â  Â  Â  #draw-pile { width: 75px; height: 105px; border: 2px solid #444; border-radius: 8px; cursor: pointer; background-color: #1a1a1a; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
Â  Â  Â  Â  #draw-count { font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000; z-index: 2; }
Â  Â  Â  Â  .play-area { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0; width: 100%; flex: 0 0 auto; }
Â  Â  Â  Â  .card-row-scroll { display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; overflow-y: hidden; width: 100%; max-width: 650px; padding: 8px 2px; min-height: 115px; scrollbar-width: thin; align-items: center; justify-content: flex-start; margin: 0 auto; }
Â  Â  Â  Â  .captured-zone { width: 95%; max-width: 650px; display: flex; flex-direction: column; gap: 2px; margin: 0 auto; }
Â  Â  Â  Â  .captured-list { display: flex; gap: 4px; overflow-x: auto; width: 100%; height: 75px; background: rgba(255,255,255,0.03); border-radius: 5px; padding: 4px; align-items: center; scrollbar-width: thin; }
Â  Â  Â  Â  .zone-label { font-size: 11px; color: var(--accent); font-weight: bold; margin-left: 5px; display: flex; justify-content: space-between; padding-right: 10px;}
Â  Â  Â  Â  .card { width: var(--card-w); height: var(--card-h); background: #fff; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 2px solid transparent; flex-shrink: 0; position: relative; }
Â  Â  Â  Â  .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }Â 
Â  Â  Â  Â  .card .c-img-front { height: 78%; }
Â  Â  Â  Â  .card .c-name { height: 22%; color: #000; font-size: 9px; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center; background: #fff; padding: 0 2px; line-height: 1.1; }
Â  Â  Â  Â  .card.selected { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
Â  Â  Â  Â  .card.highlight { border-color: #2ecc71; animation: pulse 1s infinite; }
Â  Â  Â  Â  .card.team-done { border-color: #ff4757 !important; box-shadow: 0 0 8px #ff4757 !important; }
Â  Â  Â  Â  .card-mini { width: 45px; height: 64px; border-radius: 4px; flex-shrink: 0; }
Â  Â  Â  Â  .card-mini .c-name { font-size: 7px; display: flex; height: 25%; }
Â  Â  Â  Â  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
Â  Â  Â  Â  .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); text-align: center; width: 300px; }
Â  Â  Â  Â  .side-bar { padding: 10px; background: #111; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scrollbar-width: thin; border-left: 1px solid #222; }
Â  Â  Â  Â  .team-tag { padding: 5px; border: 1px solid #333; border-radius: 4px; color: #666; font-size: 11px; text-align: center; background: #151515; }
Â  Â  Â  Â  .team-tag.active { border-color: #ff4757; color: #ff4757; background: rgba(255, 71, 87, 0.1); font-weight: bold; }
Â  Â  Â  Â  .btn { color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 12px; }
Â  Â  Â  Â  .hidden { display: none !important; }
Â  Â  Â  Â  @keyframes pulse { 0% { opacity: 0.7; } 100% { opacity: 1; } }
Â  Â  </style>
</head>
<body>

<div id="decision-modal" class="modal-overlay hidden">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h3 style="color:var(--accent); margin:0;">Báº N RÃšT ÄÆ¯á»¢C</h3>
Â  Â  Â  Â  <img id="modal-img" style="width:90px; height:125px; margin:15px auto; border:2px solid white; display:block; object-fit: cover;" src="">
Â  Â  Â  Â  <div style="display:flex; gap:10px;"><button class="btn" style="background:#2ecc71; flex:1;" onclick="resolveDraw(true)">ÄÃ“N Vá»€</button><button class="btn" style="background:#e74c3c; flex:1;" onclick="resolveDraw(false)">Táº M XA NHAU</button></div>
Â  Â  </div>
</div>

<div id="end-modal" class="modal-overlay hidden">
Â  Â  <div class="modal-content" style="width: 350px;">
Â  Â  Â  Â  <h2 style="color:var(--accent); margin-bottom: 20px;">Káº¾T THÃšC VÃN Äáº¤U</h2>
Â  Â  Â  Â  <div id="end-score-ai" style="color:#ff4757; font-size: 20px; font-weight: bold; margin-bottom: 10px;"></div>
Â  Â  Â  Â  <div id="end-score-p" style="color:#2ecc71; font-size: 20px; font-weight: bold; margin-bottom: 10px;"></div>
Â  Â  Â  Â  <div id="end-winner" style="color:#f1c40f; font-size: 18px; margin: 20px 0; border: 1px dashed #f1c40f; padding: 10px;"></div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#3498db; flex:1; padding: 12px;" onclick="location.reload()">VÃN Má»šI</button>
Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#7f8c8d; flex:1; padding: 12px;" onclick="hideEndModal()">XEM Láº I</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="pause-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:var(--accent);">â˜• NGHá»ˆ GIáº¢I LAO</h2><button class="btn" style="background:#3498db;" onclick="resumeGame()">OK TIáº¾P Tá»¤C â–¶</button></div></div>
<div id="reset-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#ff4757;">âš ï¸ Cáº¢NH BÃO</h2><p>Cháº¯c chÆ°a?</p><div style="display:flex; gap:10px;"><button class="btn" style="background:#e74c3c; flex:1;" onclick="confirmReset()">CHáº®C Rá»’I</button><button class="btn" style="background:#95a5a6; flex:1;" onclick="closeReset()">THÃ”I CHÆ I TIáº¾P</button></div></div></div>

<div id="admin-panel">
Â  Â  <div style="display:flex; justify-content: space-between; margin-bottom:10px;"><h2 style="color:var(--accent); margin:0;">ADMIN - QUáº¢N LÃ Dá»® LIá»†U</h2><button class="btn" style="background:#2ecc71; width:auto;" onclick="startGame()">VÃ€O CHÆ I LUÃ”N</button></div>
Â  Â  <div class="admin-grid">
Â  Â  Â  Â  <div class="box"><strong>1. Link áº£nh:</strong><div style="margin-bottom:10px;">Máº·t sau: <input type="text" id="back-card-url" oninput="cardBack=this.value;saveData()" style="width:70%; background:#111; color:#fff;"></div><div id="at-album" class="scroll-v" style="height:250px;"></div></div>
Â  Â  Â  Â  <div class="box"><strong>2. Táº¡o Team:</strong><input type="text" id="t-name" placeholder="TÃªn Team..." style="width:90%; margin:5px 0;"><div id="at-checklist" class="scroll-v" style="height:220px;"></div><button class="btn" style="background:#3498db;" onclick="addTeam()">+ LÆ¯U NHÃ“M</button></div>
Â  Â  Â  Â  <div class="box"><strong>3. ÄÃ£ lÆ°u:</strong><div id="team-list" class="scroll-v"></div></div>
Â  Â  </div>
</div>

<div id="game-screen" class="hidden">
Â  Â  <div class="rules-sidebar">
Â  Â  Â  Â  <h3>LUáº¬T CHÆ I</h3>
Â  Â  Â  Â  <b>1. Má»¥c tiÃªu:</b> Thu tháº­p vÃ  xáº¿p cÃ¡c lÃ¡ bÃ i theo Ä‘Ãºng team (cÃ³ liÃªn káº¿t) Ä‘á»ƒ ghi Ä‘iá»ƒm<br><br>
Â  Â  Â  Â  <b>2. Chia bÃ i:</b><br>
Â  Â  Â  Â  - Má»—i ngÆ°á»i: 7 lÃ¡ bÃ i trÃªn tay<br>
Â  Â  Â  Â  - Giá»¯a bÃ n: 8 lÃ¡ bÃ i ngá»­a<br>
Â  Â  Â  Â  - Pháº§n cÃ²n láº¡i: bÃ i Ãºp Ä‘á»ƒ rÃºt<br><br>
Â  Â  Â  Â  <b>3. LÆ°á»£t chÆ¡i & cÃ¡ch láº¥y bÃ i:</b><br>
Â  Â  Â  Â  - Má»—i lÆ°á»£t cÃ³ 15 giÃ¢y<br>
Â  Â  Â  Â  - ToÃ n bá»™ cÃ¡c lÃ¡ cÃ¹ng team (cÃ³ liÃªn káº¿t) sáº½ Ä‘Æ°á»£c chuyá»ƒn vÃ o khu â€œÄÃ£ tÃ¬m tháº¥y nhauâ€.<br>
Â  Â  Â  Â  - Háº¿t bÃ i trÃªn tay: báº¯t buá»™c rÃºt bÃ i<br>
Â  Â  Â  Â  - Chá»‰ Ä‘Æ°á»£c chá»n 1 trong 2 hÃ nh Ä‘á»™ng:<br>
Â  Â  Â  Â  * <u>Láº¥y bÃ i trÃªn bÃ n</u>: Náº¿u bÃ i trÃªn tay hoáº·c bÃ i trong khu â€œÄÃ£ tÃ¬m tháº¥y nhauâ€ cÃ³ liÃªn káº¿t vá»›i báº¥t ká»³ lÃ¡ nÃ o trÃªn bÃ n -> Ä‘Æ°á»£c láº¥y lÃ¡ Ä‘Ã³. (Báº¯t buá»™c pháº£i cÃ³ liÃªn káº¿t má»›i Ä‘Æ°á»£c láº¥y)<br>
Â  Â  Â  Â  * <u>RÃºt bÃ i Ãºp</u>: ÄÆ°á»£c rÃºt khi khÃ´ng thá»ƒ láº¥y bÃ i trÃªn bÃ n hoáº·c chá»§ Ä‘á»™ng khÃ´ng láº¥y. Sau khi rÃºt cÃ³ thá»ƒ bá» qua hoáº·c giá»¯ láº¡i trÃªn tay.<br><br>
Â  Â  Â  Â  <b>4. Káº¿t thÃºc & tÃ­nh Ä‘iá»ƒm:</b><br>
Â  Â  Â  Â  VÃ¡n káº¿t thÃºc khi má»™t bÃªn háº¿t toÃ n bá»™ bÃ i hoáº·c khÃ´ng thá»ƒ rÃºt/liÃªn káº¿t thÃªm.<br>
Â  Â  Â  Â  - Má»—i liÃªn káº¿t: <b>+1 Ä‘iá»ƒm</b><br>
Â  Â  Â  Â  - Äá»§ team: <b>+5 Ä‘iá»ƒm</b><br>
Â  Â  Â  Â  - Má»—i lÃ¡ láº» trÃªn tay: <b>-2 Ä‘iá»ƒm</b>
Â  Â  </div>

Â  Â  <div class="play-main">
Â  Â  Â  Â  <div class="play-area"><div id="ai-hand" class="card-row-scroll"></div><div class="captured-zone"><div class="zone-label"><span>ÄÃ£ tÃ¬m tháº¥y nhau</span> <span id="score-ai" style="color:#ff4757">0</span></div><div id="ai-captured" class="captured-list"></div></div></div>
Â  Â  Â  Â  <div class="play-area"><div id="board" class="card-row-scroll"></div></div>
Â  Â  Â  Â  <div id="restart-overlay" class="hidden" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50;">
Â  Â  <button class="btn" style="background: var(--accent); color: #000; padding: 15px 30px; font-size: 18px; box-shadow: 0 0 20px rgba(241, 196, 15, 0.4);" onclick="location.reload()">
Â  Â  Â  Â  ğŸ”¥ Báº®T Äáº¦U VÃN Má»šI
Â  Â  </button>
</div>
Â  Â  Â  Â  <div class="play-area"><div class="captured-zone"><div class="zone-label"><span>ÄÃ£ tÃ¬m tháº¥y nhau</span> <span id="score-p" style="color:#2ecc71">0</span></div><div id="p-captured" class="captured-list"></div></div><div id="p-hand" class="card-row-scroll"></div></div>
Â  Â  Â  Â  <div class="right-controls"><div class="circle-ui"><div id="timer-val">15</div><div class="timer-label">GIÃ‚Y</div></div><div id="turn-circle" class="circle-ui p-active"><div id="turn-indicator">GAI<br>CON</div></div><div id="draw-pile" onclick="playerDraw()"><span id="draw-count"></span></div></div>
Â  Â  </div>
<div class="side-bar">
Â  Â  <div style="text-align:center; margin-bottom: 10px;">
Â  Â  Â  Â  <h4 style="color:var(--accent); margin:0;">CÃC TEAM</h4>
Â  Â  Â  Â  <small style="color: white; font-size: 10px; opacity: 0.8;">Tá»± Ã´n bÃ i nhÃ©!</small>
Â  Â  </div>
Â  Â  <div id="side-teams" class="scroll-v" style="height:450px;"></div>Â  Â  Â  Â Â 
Â  Â  </div><button class="btn" style="background:#3498db;" onclick="togglePause()">Táº¡m dá»«ng</button><button class="btn" style="background:#9b59b6;" onclick="resetGame()">LÃ m láº¡i</button></div>
</div>

<script>
Â  Â  const AT_NAMES = ["Há»“ng SÆ¡n","Báº±ng Kiá»u","Tá»± Long","Phan Äinh TÃ¹ng","Tuáº¥n HÆ°ng","Äinh Tiáº¿n Äáº¡t","Pháº¡m KhÃ¡nh HÆ°ng","Tiáº¿n Luáº­t","ThÃ nh Trung","ÄÄƒng KhÃ´i","TrÆ°Æ¡ng Tháº¿ Vinh","HÃ  LÃª","Äá»— HoÃ ng Hiá»‡p","Thanh Duy","Quá»‘c ThiÃªn","Binz","CÆ°á»ng Seven","Nguyá»…n Tráº§n Duy Nháº¥t","Jun Pháº¡m","Neko LÃª","TÄƒng PhÃºc","ThiÃªn Minh","BB Tráº§n","LiÃªn Bá»‰nh PhÃ¡t","S.T SÆ¡n Tháº¡ch","Rhymastic","KiÃªn á»¨ng","(S)TRONG Trá»ng Hiáº¿u","Soobin HoÃ ng SÆ¡n","Kay Tráº§n","BÃ¹i CÃ´ng Nam","Duy KhÃ¡nh","HuyR","Anh Tuáº¥n","SLIMV","Äinh HÃ  UyÃªn ThÆ°","VÄ© Khang","Long Kenji","KhÃ¡nh Vy","NhÃ  Äam MÃª","NhÃ  KK","NhÃ  Sao SÃ¡ng","NhÃ  TÃ¡i Sinh","NhÃ  NgÅ© HÃ nh","NhÃ  HÃ¡t","NhÃ  XuÃ¢n Háº¡ Thu ÄÃ´ng","NhÃ  XÆ°Æ¡ng Rá»“ng","Gai Con","Concert","Há»a Ca"];
Â  Â  let teams = [], at_images = {}, cardBack = "", isPaused = false;
Â  Â  let game = { pHand:[], aiHand:[], board:[], deck:[], pCap:[], aiCap:[], turn:'p', selected:null, time:15, iv:null, isGameOver: false };
Â  Â Â 
Â  Â  function drive(url) {Â 
Â  Â  Â  Â  if(!url || !url.includes('drive.google.com')) return url;Â 
Â  Â  Â  Â  let id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];Â 
Â  Â  Â  Â  return `https://lh3.googleusercontent.com/u/0/d/${id}`;
Â  Â  }

Â  Â  window.onload = async () => {
Â  Â  const localData = localStorage.getItem('at_v23_data');
Â  Â  if(localData) {
Â  Â  Â  Â  const d = JSON.parse(localData);
Â  Â  Â  Â  at_images = d.images || {};
Â  Â  Â  Â  teams = d.teams || [];
Â  Â  Â  Â  cardBack = d.cardBack || "";
Â  Â  }
Â  Â  try {
Â  Â  Â  Â  const res = await fetch('./data.json?t=' + Date.now());
Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  if(!cardBack) cardBack = data.cardBack || "";
Â  Â  Â  Â  Â  Â  if(teams.length === 0) teams = data.teams || [];
Â  Â  Â  Â  Â  Â  if(Object.keys(at_images).length === 0) at_images = data.images || {};
Â  Â  Â  Â  }
Â  Â  } catch (e) { console.log("DÃ¹ng dá»¯ liá»‡u Local."); }

Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  if (urlParams.get('play') === 'true') {
Â  Â  Â  Â  startGame();
Â  Â  } else {
Â  Â  Â  Â  document.getElementById('admin-panel').style.display = 'block';
Â  Â  Â  Â  renderAdmin();
Â  Â  }
};

Â  Â  function renderAdmin() {
Â  Â  Â  Â  document.getElementById('back-card-url').value = cardBack;
Â  Â  Â  Â  document.getElementById('at-album').innerHTML = AT_NAMES.map((n, i) => `<div style="font-size:10px;">${i+1}. ${n} <input type="text" value="${at_images[i+1] || ''}" oninput="at_images[${i+1}]=this.value;saveData()" style="width:60%; background:#111; color:#fff;"></div>`).join('');
Â  Â  Â  Â  document.getElementById('at-checklist').innerHTML = AT_NAMES.map((n, i) => `<div><input type="checkbox" value="${i+1}" class="chk-at"> ${n}</div>`).join('');
Â  Â  Â  Â  renderTeamList();
Â  Â  }

Â  Â  function addTeam() {
Â  Â  Â  Â  const name = document.getElementById('t-name').value;
Â  Â  Â  Â  const checkboxes = document.querySelectorAll('.chk-at:checked');
Â  Â  Â  Â  const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
Â  Â  Â  Â  if(!name || ids.length < 2) return;
Â  Â  Â  Â  teams.push({ name, members: ids });
Â  Â  Â  Â  renderTeamList(); saveData();
Â  Â  Â  Â  document.getElementById('t-name').value = "";
Â  Â  Â  Â  checkboxes.forEach(cb => cb.checked = false);
Â  Â  }

Â  Â  function renderTeamList() {Â 
Â  Â  Â  Â  document.getElementById('team-list').innerHTML = teams.map((t, i) => `<div class="team-item"><strong>${t.name}</strong><span onclick="teams.splice(${i},1);renderTeamList();saveData()" style="color:#ff4757; float:right; cursor:pointer;">X</span><div style="font-size:10px; color:#aaa; margin-top:4px;">${t.members.map(m => AT_NAMES[m-1]).join(', ')}</div></div>`).join('');
Â  Â  }

Â  Â  function saveData() { localStorage.setItem('at_v23_data', JSON.stringify({ images: at_images, teams: teams, cardBack: cardBack })); }

Â  Â  function startGame() {
Â  Â  Â  Â  document.getElementById('restart-overlay').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('admin-panel').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('game-screen').classList.remove('hidden');
Â  Â  Â  Â  let fullDeck = AT_NAMES.map((n, i) => ({ id: i+1, name: n, img: drive(at_images[i+1]) }));
Â  Â  Â  Â  for (let i = fullDeck.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  Â  [fullDeck[i], fullDeck[j]] = [fullDeck[j], fullDeck[i]];
Â  Â  Â  Â  }
Â  Â  Â  Â  game.pHand = fullDeck.splice(0, 7); game.aiHand = fullDeck.splice(0, 7);
Â  Â  Â  Â  game.board = fullDeck.splice(0, 8); game.deck = fullDeck;
Â  Â  Â  Â  game.pCap = []; game.aiCap = []; game.turn = 'p';
Â  Â  Â  Â  game.isGameOver = false;
Â  Â  Â  Â  document.getElementById('side-teams').innerHTML = teams.map(t => `<div id="tag-${t.name.replace(/\s/g,'')}" class="team-tag">${t.name}</div>`).join('');
Â  Â  Â  Â  updateUI(); startTimer();
Â  Â  }

Â  Â  function calculateScore(captured, hand, isFinal = false) {
Â  Â  Â  Â  let s = captured.length;
Â  Â  Â  Â  teams.forEach(t => { if(t.members.every(mId => captured.some(c => c.id === mId))) s += 5; });
Â  Â  Â  Â  if(isFinal) { s -= (hand.length * 2); }
Â  Â  Â  Â  return s;
Â  Â  }

Â  Â  function updateUI() {
Â  Â  Â  Â  document.getElementById('score-p').innerText = calculateScore(game.pCap, game.pHand);
Â  Â  Â  Â  document.getElementById('score-ai').innerText = calculateScore(game.aiCap, game.aiHand);
Â  Â  Â  Â  const tc = document.getElementById('turn-circle');
Â  Â  Â  Â  document.getElementById('turn-indicator').innerHTML = game.turn === 'p' ? "GAI<br>CON" : "ANH<br>TÃ€I";
Â  Â  Â  Â  tc.className = game.turn === 'p' ? "circle-ui p-active" : "circle-ui ai-active";
Â  Â  Â  Â  document.getElementById('draw-count').innerText = game.deck.length;
Â  Â  Â  Â  if(cardBack) document.getElementById('draw-pile').style.backgroundImage = `url('${drive(cardBack)}')`;

Â  Â  Â  Â  const cardH = (c, isP) => `<div class="card ${game.selected === c.id ? 'selected' : ''}" onclick="${isP ? `selectCard(${c.id})` : ''}"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Logic láº­t bÃ i AI khi game over
Â  Â  Â  Â  document.getElementById('ai-hand').innerHTML = game.aiHand.map(c => {
Â  Â  Â  Â  Â  Â  if (game.isGameOver) {
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="card"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return cardBack ? `<div class="card"><img src="${drive(cardBack)}"></div>` : `<div class="card" style="background:#222;"></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }).join('');
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('p-hand').innerHTML = game.pHand.map(c => cardH(c, true)).join('');
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('board').innerHTML = game.board.map(c => {
Â  Â  Â  Â  Â  Â  const linkWithSelected = game.selected && teams.some(t => t.members.includes(game.selected) && t.members.includes(c.id));
Â  Â  Â  Â  Â  Â  const linkWithCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
Â  Â  Â  Â  Â  Â  const isHighlight = (game.turn === 'p' && (linkWithSelected || linkWithCap));
Â  Â  Â  Â  Â  Â  return `<div class="card ${isHighlight ? 'highlight' : ''}" onclick="takeCard(${c.id})"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  const mini = (c, ownerCap) => {
Â  Â  Â  Â  Â  Â  const myTeam = teams.find(t => t.members.includes(c.id));
Â  Â  Â  Â  Â  Â  const isDone = myTeam && myTeam.members.every(mId => ownerCap.some(oc => oc.id === mId));
Â  Â  Â  Â  Â  Â  return `<div class="card card-mini ${isDone ? 'team-done' : ''}"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
Â  Â  Â  Â  };
Â  Â  Â  Â  document.getElementById('p-captured').innerHTML = renderCapturedSorted(game.pCap);
Â  Â  Â  Â  document.getElementById('ai-captured').innerHTML = renderCapturedSorted(game.aiCap);
Â  Â  Â  Â Â 
Â  Â  Â  Â  teams.forEach(t => {Â 
Â  Â  Â  Â  Â  Â  const ok = t.members.every(mId => game.pCap.some(c => c.id === mId)) || t.members.every(mId => game.aiCap.some(c => c.id === mId));Â 
Â  Â  Â  Â  Â  Â  const el = document.getElementById(`tag-${t.name.replace(/\s/g,'')}`);Â 
Â  Â  Â  Â  Â  Â  if(el) el.className = ok ? 'team-tag active' : 'team-tag';Â 
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const restartBtn = document.getElementById('restart-overlay');
Â  Â  if (game.isGameOver) {
Â  Â  Â  Â  restartBtn.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  Â  restartBtn.classList.add('hidden');
Â  Â  }

Â  Â  // Gá»i checkEndGame cuá»‘i cÃ¹ng
Â  Â  checkEndGame();
}
Â  Â  }

Â  Â  function selectCard(id) { if(game.turn === 'p') { game.selected = (game.selected === id) ? null : id; updateUI(); } }

Â  Â  function takeCard(bId) {
Â  Â  Â  Â  if(game.turn !== 'p' || isPaused) return;
Â  Â  Â  Â  const bc = game.board.find(x => x.id === bId);
Â  Â  Â  Â  const mMatchCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(bId)));
Â  Â  Â  Â  if(mMatchCap) { game.pCap.push(bc); game.board = game.board.filter(x => x.id !== bId); nextTurn(); return; }
Â  Â  Â  Â  if(game.selected) {Â 
Â  Â  Â  Â  Â  Â  const matchHand = teams.some(t => t.members.includes(game.selected) && t.members.includes(bId));
Â  Â  Â  Â  Â  Â  if(matchHand) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  game.pCap.push(bc, game.pHand.find(x => x.id === game.selected));Â 
Â  Â  Â  Â  Â  Â  Â  Â  game.board = game.board.filter(x => x.id !== bId);
Â  Â  Â  Â  Â  Â  Â  Â  game.pHand = game.pHand.filter(x => x.id !== game.selected);Â 
Â  Â  Â  Â  Â  Â  Â  Â  game.selected = null; nextTurn();Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }
Â  Â  }
// --- THAY THáº¾ Tá»ª ÄÃ‚Y ---

function renderCapturedSorted(capList) {
Â  Â  if (!capList || capList.length === 0) return "";

Â  Â  // 1. Táº¡o báº£n sao Ä‘á»ƒ sáº¯p xáº¿p
Â  Â  let sortedList = [...capList];

Â  Â  // 2. Sáº¯p xáº¿p: CÃ¡c lÃ¡ cÃ¹ng Team Ä‘á»©ng cáº¡nh nhau
Â  Â  sortedList.sort((a, b) => {
Â  Â  Â  Â  const teamA = teams.findIndex(t => t.members.includes(a.id));
Â  Â  Â  Â  const teamB = teams.findIndex(t => t.members.includes(b.id));
Â  Â  Â  Â  return teamA - teamB;
Â  Â  });

Â  Â  // 3. Tráº£ vá» HTML pháº³ng (GiÃºp bÃ i náº±m trÃªn 1 hÃ ng ngang)
Â  Â  return sortedList.map(c => {
Â  Â  Â  Â  const myTeam = teams.find(t => t.members.includes(c.id));
Â  Â  Â  Â  const isDone = myTeam && myTeam.members.every(mId => capList.some(oc => oc.id === mId));
Â  Â  Â  Â  return `<div class="card card-mini ${isDone ? 'team-done' : ''}"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
Â  Â  }).join('');
}

function playerDraw() {Â 
Â  Â  if(game.turn !== 'p' || isPaused || game.deck.length === 0) return;
Â  Â  game.tempDraw = game.deck.shift();Â 
Â  Â  document.getElementById('decision-modal').classList.remove('hidden');Â 
Â  Â  document.getElementById('modal-img').src = game.tempDraw.img;Â 
}

function resolveDraw(isK) {Â 
Â  Â  document.getElementById('decision-modal').classList.add('hidden');Â 
Â  Â  let c = game.tempDraw;
Â  Â  if(isK) {Â 
Â  Â  Â  Â  let inCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
Â  Â  Â  Â  let inHandMatch = game.pHand.find(ph => teams.some(t => t.members.includes(ph.id) && t.members.includes(c.id)));
Â  Â  Â  Â  if (inCap) { game.pCap.push(c); }Â 
Â  Â  Â  Â  else if (inHandMatch) { game.pCap.push(c, inHandMatch); game.pHand = game.pHand.filter(x => x.id !== inHandMatch.id); }Â 
Â  Â  Â  Â  else { game.pHand.push(c); }
Â  Â  } else { game.board.push(c); }Â 
Â  Â  game.tempDraw = null; nextTurn();Â 
}

function startTimer() {Â 
Â  Â  clearInterval(game.iv);
Â  Â  if (game.isGameOver) return;
Â  Â  game.time = 15; document.getElementById('timer-val').innerText = game.time;
Â  Â  game.iv = setInterval(() => {Â 
Â  Â  Â  Â  if(!isPaused) {Â 
Â  Â  Â  Â  Â  Â  game.time--;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('timer-val').innerText = game.time;Â 
Â  Â  Â  Â  Â  Â  if(game.turn === 'ai' && game.time === 7) aiMove();Â 
Â  Â  Â  Â  Â  Â  if(game.time <= 0) nextTurn();Â 
Â  Â  Â  Â  }Â 
Â  Â  }, 1000);
}

function nextTurn() {Â 
Â  Â  if(game.tempDraw) {Â 
Â  Â  Â  Â  game.board.push(game.tempDraw);Â 
Â  Â  Â  Â  game.tempDraw = null;Â 
Â  Â  Â  Â  document.getElementById('decision-modal').classList.add('hidden');Â 
Â  Â  }
Â  Â  game.turn = (game.turn === 'p' ? 'ai' : 'p');Â 
Â  Â  updateUI();Â 
Â  Â  startTimer();Â 
}

function aiMove() {
Â  Â  if (isPaused) return;
Â  Â  let acted = false;

Â  Â  for (let ah of game.aiHand) {
Â  Â  Â  Â  let target = game.board.find(bc => teams.some(t => t.members.includes(ah.id) && t.members.includes(bc.id)));
Â  Â  Â  Â  if (target) {
Â  Â  Â  Â  Â  Â  game.aiCap.push(ah, target);
Â  Â  Â  Â  Â  Â  game.aiHand = game.aiHand.filter(x => x.id !== ah.id);
Â  Â  Â  Â  Â  Â  game.board = game.board.filter(x => x.id !== target.id);
Â  Â  Â  Â  Â  Â  acted = true;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (!acted) {
Â  Â  Â  Â  let target = game.board.find(bc => game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(bc.id))));
Â  Â  Â  Â  if (target) {
Â  Â  Â  Â  Â  Â  game.aiCap.push(target);
Â  Â  Â  Â  Â  Â  game.board = game.board.filter(x => x.id !== target.id);
Â  Â  Â  Â  Â  Â  acted = true;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (!acted && game.deck.length > 0) {
Â  Â  Â  Â  let c = game.deck.shift();Â 
Â  Â  Â  Â  let linkCap = game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(c.id)));
Â  Â  Â  Â  if (linkCap) {
Â  Â  Â  Â  Â  Â  game.aiCap.push(c);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  let linkHand = game.aiHand.find(ah => teams.some(t => t.members.includes(ah.id) && t.members.includes(c.id)));
Â  Â  Â  Â  Â  Â  if (linkHand) {
Â  Â  Â  Â  Â  Â  Â  Â  game.aiCap.push(c, linkHand);
Â  Â  Â  Â  Â  Â  Â  Â  game.aiHand = game.aiHand.filter(x => x.id !== linkHand.id);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let linkBoard = game.board.some(b => teams.some(t => t.members.includes(b.id) && t.members.includes(c.id)));
Â  Â  Â  Â  Â  Â  Â  Â  if (linkBoard) { game.aiHand.push(c); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { game.board.push(c); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  acted = true;
Â  Â  }
Â  Â  nextTurn();
}

function autoMoveToEnd(playerHand, playerCap) {
Â  Â  let changed = true;
Â  Â  while (changed) {
Â  Â  Â  Â  changed = false;
Â  Â  Â  Â  for (let i = 0; i < playerHand.length; i++) {
Â  Â  Â  Â  Â  Â  let c = playerHand[i];
Â  Â  Â  Â  Â  Â  let hasLink = playerCap.some(pc =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id))
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (hasLink) {
Â  Â  Â  Â  Â  Â  Â  Â  playerCap.push(c);
Â  Â  Â  Â  Â  Â  Â  Â  playerHand.splice(i, 1);
Â  Â  Â  Â  Â  Â  Â  Â  i--;
Â  Â  Â  Â  Â  Â  Â  Â  changed = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!changed) {
Â  Â  Â  Â  Â  Â  for (let i = 0; i < playerHand.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let j = i + 1; j < playerHand.length; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isTeam = teams.some(t =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.members.includes(playerHand[i].id) && t.members.includes(playerHand[j].id)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isTeam) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerCap.push(playerHand[i], playerHand[j]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerHand.splice(j, 1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerHand.splice(i, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  changed = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (changed) break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
}

// --- Háº¾T ÄOáº N THAY THáº¾ ---
Â  Â Â 
Â  Â  function hasPossibleMove(hand, cap) {
Â  Â  Â  Â  const handMatch = hand.some(h => game.board.some(b => teams.some(t => t.members.includes(h.id) && t.members.includes(b.id))));
Â  Â  Â  Â  const capMatch = game.board.some(b => cap.some(c => teams.some(t => t.members.includes(c.id) && t.members.includes(b.id))));
Â  Â  Â  Â  return handMatch || capMatch;
Â  Â  }

Â  Â  function checkEndGame() {Â 
Â  Â  Â  Â  // QUAN TRá»ŒNG: NgÄƒn cháº·n vÃ²ng láº·p vÃ´ táº­n
Â  Â  Â  Â  if (game.isGameOver) return;

Â  Â  Â  Â  const noMovesLeft = game.deck.length === 0 && !hasPossibleMove(game.pHand, game.pCap) && !hasPossibleMove(game.aiHand, game.aiCap);

Â  Â  Â  Â  if((game.board.length === 0 && game.deck.length === 0) ||Â 
Â  Â  Â  Â  Â  Â (game.deck.length === 0 && (game.pHand.length === 0 || game.aiHand.length === 0)) ||
Â  Â  Â  Â  Â  Â noMovesLeft) {Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  clearInterval(game.iv);
Â  Â  Â  Â  Â  Â  game.isGameOver = true; // ÄÃ¡nh dáº¥u game over ngay láº­p tá»©c
Â  Â  Â  Â  Â  Â  autoMoveToEnd(game.pHand, game.pCap);
Â  Â  Â  Â  Â  Â  autoMoveToEnd(game.aiHand, game.aiCap);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  updateUI(); // Gá»i updateUI 1 láº§n cuá»‘i Ä‘á»ƒ láº­t bÃ i (nhá» dÃ²ng check á»Ÿ Ä‘áº§u hÃ m nÃ y mÃ  nÃ³ sáº½ khÃ´ng láº·p láº¡i)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let pF = calculateScore(game.pCap, game.pHand, true);
Â  Â  Â  Â  Â  Â  let aF = calculateScore(game.aiCap, game.aiHand, true);
Â  Â  Â  Â  Â  Â  showEndPopup(pF, aF);
Â  Â  Â  Â  }Â 
Â  Â  }

Â  Â  function showEndPopup(pScore, aiScore) {
Â  Â  Â  Â  const modal = document.getElementById('end-modal');
Â  Â  Â  Â  document.getElementById('end-score-ai').innerText = `Anh TÃ i: ${aiScore}`;
Â  Â  Â  Â  document.getElementById('end-score-p').innerText = `Gai Con: ${pScore}`;
Â  Â  Â  Â  let winner = pScore > aiScore ? "Gai Con" : (aiScore > pScore ? "Anh TÃ i" : "HÃ²a nhau");
Â  Â  Â  Â  document.getElementById('end-winner').innerText = `ChÃºc má»«ng ngÆ°á»i chiáº¿n tháº¯ng lÃ  ${winner}`;
Â  Â  Â  Â  modal.classList.remove('hidden');
Â  Â  }
Â  Â  function hideEndModal() {
Â  Â  document.getElementById('end-modal').classList.add('hidden');
}
Â  Â  function togglePause() { isPaused = true; document.getElementById('pause-modal').classList.remove('hidden'); }
Â  Â  function resumeGame() { isPaused = false; document.getElementById('pause-modal').classList.add('hidden'); }
Â  Â  function resetGame() { document.getElementById('reset-modal').classList.remove('hidden'); }
Â  Â  function confirmReset() { document.getElementById('reset-modal').classList.add('hidden'); startGame(); }
Â  Â  function closeReset() { document.getElementById('reset-modal').classList.add('hidden'); }
</script>
</body>
</html>

