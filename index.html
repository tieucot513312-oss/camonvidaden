<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cảm Ơn Vì Đã Đến</title>
    <style>
        /* GIỮ NGUYÊN PHẦN CSS CỦA BẠN */
        :root { --bg: #0a0a0a; --accent: #f1c40f; --card-w: 72px; --card-h: 100px; --panel-bg: #111; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        #admin-panel { background: #1a1a1a; padding: 15px; border-bottom: 3px solid #333; max-height: 90vh; overflow-y: auto; z-index: 1000; position: relative; }
        .admin-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; }
        .box { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .scroll-v { height: 350px; overflow-y: auto; background: #000; padding: 8px; border-radius: 5px; }
        .team-item { background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 3px solid var(--accent); }
        #game-screen { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; background: #050505; }
        .rules-sidebar { background: var(--panel-bg); border-right: 1px solid #333; padding: 15px; overflow-y: auto; font-size: 13px; color: #ddd; }
        .play-main { display: flex; flex-direction: column; height: 100vh; position: relative; justify-content: center; align-items: center; gap: 15px; }
        .right-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .circle-ui { width: 70px; height: 70px; border-radius: 50%; background: #222; border: 3px solid #444; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; }
        #timer-val { font-size: 32px; color: var(--accent); }
        .p-active { border-color: #2ecc71; color: #2ecc71; }
        .ai-active { border-color: #ff4757; color: #ff4757; }
        #draw-pile { width: 75px; height: 105px; border: 2px solid #444; border-radius: 8px; cursor: pointer; background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; }
        .play-area { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .card-row-scroll { display: flex; gap: 8px; overflow-x: auto; width: 100%; max-width: 650px; min-height: 115px; padding: 5px; }
        .captured-zone { width: 95%; max-width: 650px; }
        .captured-list { display: flex; gap: 4px; overflow-x: auto; height: 75px; background: rgba(255,255,255,0.03); padding: 4px; }
        .card { width: var(--card-w); height: var(--card-h); background: #fff; border-radius: 6px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; color: #000; overflow: hidden;}
        .card img { width: 100%; height: 75%; object-fit: cover; }
        .card .c-name { height: 25%; font-size: 9px; text-align: center; font-weight: bold; }
        .card.selected { border-color: var(--accent); transform: scale(1.05); }
        .card.highlight { border-color: #2ecc71; }
        .card-mini { width: 45px; height: 64px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); text-align: center; width: 300px; }
        .side-bar { padding: 10px; background: #111; overflow-y: auto; border-left: 1px solid #222; }
        .team-tag { padding: 5px; border: 1px solid #333; margin-bottom: 5px; font-size: 11px; text-align: center; }
        .team-tag.active { border-color: #ff4757; color: #ff4757; }
        .btn { color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="decision-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--accent);">BẠN RÚT ĐƯỢC</h3>
        <img id="modal-img" style="width:90px; height:125px; margin:15px auto; display:block; object-fit: cover;" src="">
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#2ecc71;" onclick="resolveDraw(true)">ĐÓN VỀ</button>
            <button class="btn" style="background:#e74c3c;" onclick="resolveDraw(false)">TẠM XA</button>
        </div>
    </div>
</div>

<div id="end-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color:var(--accent);">KẾT THÚC</h2>
        <div id="end-score-ai"></div>
        <div id="end-score-p"></div>
        <div id="end-winner" style="margin:15px 0;"></div>
        <button class="btn" style="background:#3498db;" onclick="location.reload()">CHƠI LẠI</button>
    </div>
</div>

<div id="admin-panel">
    <div style="display:flex; justify-content: space-between;">
        <h2 style="color:var(--accent);">ADMIN PANEL</h2>
        <button class="btn" style="background:#2ecc71; width:auto; padding:0 20px;" onclick="startGame()">VÀO CHƠI</button>
    </div>
    <div class="admin-grid">
        <div class="box"><strong>1. Ảnh mặt sau:</strong><input type="text" id="back-card-url" oninput="cardBack=this.value;saveData()" style="width:100%;">
             <div id="at-album" class="scroll-v" style="margin-top:10px;"></div>
        </div>
        <div class="box"><strong>2. Tạo Team:</strong><input type="text" id="t-name" placeholder="Tên nhóm..."><div id="at-checklist" class="scroll-v"></div><button class="btn" style="background:#3498db;" onclick="addTeam()">LƯU NHÓM</button></div>
        <div class="box"><strong>3. Danh sách Team:</strong><div id="team-list" class="scroll-v"></div></div>
    </div>
</div>

<div id="game-screen" class="hidden">
    <div class="rules-sidebar">
        <h3>LUẬT CHƠI</h3>
        <p>Chọn bài trên tay, nếu cùng nhóm với bài trên bàn -> Thu thập.</p>
        <p>Mỗi liên kết: +1đ. Đủ nhóm: +5đ. Bài lẻ trên tay: -2đ.</p>
    </div>

    <div class="play-main">
        <div class="play-area"><div id="ai-hand" class="card-row-scroll"></div><div class="captured-zone"><div class="zone-label">AI Thu thập: <span id="score-ai">0</span></div><div id="ai-captured" class="captured-list"></div></div></div>
        <div class="play-area"><div id="board" class="card-row-scroll"></div></div>
        <div class="play-area"><div class="captured-zone"><div class="zone-label">Bạn Thu thập: <span id="score-p">0</span></div><div id="p-captured" class="captured-list"></div></div><div id="p-hand" class="card-row-scroll"></div></div>
        
        <div class="right-controls">
            <div class="circle-ui"><div id="timer-val">15</div></div>
            <div id="turn-circle" class="circle-ui"><div id="turn-indicator">LƯỢT</div></div>
            <div id="draw-pile" onclick="playerDraw()"><span id="draw-count">0</span></div>
        </div>
    </div>

    <div class="side-bar">
        <h4 style="color:var(--accent); text-align:center;">NHÓM</h4>
        <div id="side-teams"></div>
        <button class="btn" style="background:#e74c3c; margin-top:20px;" onclick="location.reload()">RESET</button>
    </div>
</div>

<script>
    const AT_NAMES = ["Hồng Sơn","Bằng Kiều","Tự Long","Phan Đinh Tùng","Tuấn Hưng","Đinh Tiến Đạt","Phạm Khánh Hưng","Tiến Luật","Thành Trung","Đăng Khôi","Trương Thế Vinh","Hà Lê","Đỗ Hoàng Hiệp","Thanh Duy","Quốc Thiên","Binz","Cường Seven","Nguyễn Trần Duy Nhất","Jun Phạm","Neko Lê","Tăng Phúc","Thiên Minh","BB Trần","Liên Bỉnh Phát","S.T Sơn Thạch","Rhymastic","Kiên Ứng","(S)TRONG Trọng Hiếu","Soobin Hoàng Sơn","Kay Trần","Bùi Công Nam","Duy Khánh","HuyR","Anh Tuấn"];
    let teams = [], at_images = {}, cardBack = "", isPaused = false;
    let game = { pHand:[], aiHand:[], board:[], deck:[], pCap:[], aiCap:[], turn:'p', selected:null, time:15, iv:null, isGameOver: false };

    // Sửa lỗi link Drive
    function drive(url) { 
        if(!url || !url.includes('drive.google.com')) return url; 
        let id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0]; 
        return `https://lh3.googleusercontent.com/d/${id}`;
    }

    window.onload = () => {
        const localData = localStorage.getItem('at_v23_data');
        if(localData) {
            const d = JSON.parse(localData);
            at_images = d.images || {};
            teams = d.teams || [];
            cardBack = d.cardBack || "";
        }
        renderAdmin();
    };

    function renderAdmin() {
        document.getElementById('at-album').innerHTML = AT_NAMES.map((n, i) => `<div>${n}: <input type="text" value="${at_images[i+1] || ''}" oninput="at_images[${i+1}]=this.value;saveData()"></div>`).join('');
        document.getElementById('at-checklist').innerHTML = AT_NAMES.map((n, i) => `<div><input type="checkbox" value="${i+1}" class="chk-at"> ${n}</div>`).join('');
        renderTeamList();
    }

    function addTeam() {
        const name = document.getElementById('t-name').value;
        const ids = Array.from(document.querySelectorAll('.chk-at:checked')).map(cb => parseInt(cb.value));
        if(!name || ids.length < 2) return;
        teams.push({ name, members: ids });
        renderTeamList(); saveData();
    }

    function renderTeamList() {
        document.getElementById('team-list').innerHTML = teams.map((t, i) => `<div class="team-item">${t.name} <span onclick="teams.splice(${i},1);renderTeamList();saveData()" style="color:red; cursor:pointer;">[X]</span></div>`).join('');
    }

    function saveData() { localStorage.setItem('at_v23_data', JSON.stringify({ images: at_images, teams, cardBack })); }

    function startGame() {
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        let fullDeck = AT_NAMES.map((n, i) => ({ id: i+1, name: n, img: drive(at_images[i+1]) }));
        fullDeck = fullDeck.sort(() => Math.random() - 0.5);

        game.pHand = fullDeck.splice(0, 7); 
        game.aiHand = fullDeck.splice(0, 7);
        game.board = fullDeck.splice(0, 8); 
        game.deck = fullDeck;
        
        document.getElementById('side-teams').innerHTML = teams.map(t => `<div id="tag-${t.name.replace(/\s/g,'')}" class="team-tag">${t.name}</div>`).join('');
        
        updateUI();
        startTimer();
    }

    function updateUI() {
        document.getElementById('score-p').innerText = calculateScore(game.pCap, game.pHand);
        document.getElementById('score-ai').innerText = calculateScore(game.aiCap, game.aiHand);
        document.getElementById('draw-count').innerText = game.deck.length;

        const turnInd = document.getElementById('turn-indicator');
        const turnCir = document.getElementById('turn-circle');
        turnInd.innerText = game.turn === 'p' ? "BẠN" : "AI";
        turnCir.className = game.turn === 'p' ? "circle-ui p-active" : "circle-ui ai-active";

        // Render Hands
        document.getElementById('p-hand').innerHTML = game.pHand.map(c => `
            <div class="card ${game.selected === c.id ? 'selected' : ''}" onclick="selectCard(${c.id})">
                <img src="${c.img || ''}"><div class="c-name">${c.name}</div>
            </div>`).join('');

        document.getElementById('ai-hand').innerHTML = game.aiHand.map(c => `
            <div class="card" style="background:#333;">${game.isGameOver ? `<img src="${c.img}"><div class="c-name">${c.name}</div>` : ''}</div>
        `).join('');

        // Render Board
        document.getElementById('board').innerHTML = game.board.map(c => {
            const isMatch = game.selected && teams.some(t => t.members.includes(game.selected) && t.members.includes(c.id));
            return `<div class="card ${isMatch ? 'highlight' : ''}" onclick="takeCard(${c.id})"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        }).join('');

        // Render Captured
        document.getElementById('p-captured').innerHTML = game.pCap.map(c => `<div class="card card-mini"><img src="${c.img}"></div>`).join('');
        document.getElementById('ai-captured').innerHTML = game.aiCap.map(c => `<div class="card card-mini"><img src="${c.img}"></div>`).join('');
    }

    function calculateScore(cap, hand, final = false) {
        let s = cap.length;
        teams.forEach(t => { if(t.members.every(m => cap.some(c => c.id === m))) s += 5; });
        if(final) s -= (hand.length * 2);
        return s;
    }

    function selectCard(id) { 
        if(game.turn !== 'p') return;
        game.selected = (game.selected === id) ? null : id; 
        updateUI(); 
    }

    function takeCard(bId) {
        if(game.turn !== 'p' || !game.selected) return;
        const bc = game.board.find(x => x.id === bId);
        const isMatch = teams.some(t => t.members.includes(game.selected) && t.members.includes(bId));
        
        if(isMatch) {
            game.pCap.push(bc, game.pHand.find(x => x.id === game.selected));
            game.board = game.board.filter(x => x.id !== bId);
            game.pHand = game.pHand.filter(x => x.id !== game.selected);
            game.selected = null;
            nextTurn();
        }
    }

    function playerDraw() {
        if(game.turn !== 'p' || game.deck.length === 0) return;
        game.tempDraw = game.deck.shift();
        document.getElementById('modal-img').src = game.tempDraw.img;
        document.getElementById('decision-modal').classList.remove('hidden');
    }

    function resolveDraw(keep) {
        document.getElementById('decision-modal').classList.add('hidden');
        if(keep) game.pHand.push(game.tempDraw);
        else game.board.push(game.tempDraw);
        game.tempDraw = null;
        nextTurn();
    }

    function startTimer() {
        clearInterval(game.iv);
        game.time = 15;
        document.getElementById('timer-val').innerText = game.time;
        game.iv = setInterval(() => {
            game.time--;
            document.getElementById('timer-val').innerText = game.time;
            if(game.turn === 'ai' && game.time === 10) aiMove();
            if(game.time <= 0) nextTurn();
        }, 1000);
    }

    function nextTurn() {
        if(game.isGameOver) return;
        game.turn = game.turn === 'p' ? 'ai' : 'p';
        updateUI();
        checkEndGame();
        if(!game.isGameOver) startTimer();
    }

    function aiMove() {
        let acted = false;
        // AI tìm cặp
        for(let ah of game.aiHand) {
            let target = game.board.find(b => teams.some(t => t.members.includes(ah.id) && t.members.includes(b.id)));
            if(target) {
                game.aiCap.push(ah, target);
                game.aiHand = game.aiHand.filter(x => x.id !== ah.id);
                game.board = game.board.filter(x => x.id !== target.id);
                acted = true; break;
            }
        }
        if(!acted && game.deck.length > 0) game.board.push(game.deck.shift());
        nextTurn();
    }

    function checkEndGame() {
        if(game.deck.length === 0 && (game.pHand.length === 0 || game.aiHand.length === 0)) {
            game.isGameOver = true;
            clearInterval(game.iv);
            document.getElementById('end-modal').classList.remove('hidden');
            document.getElementById('end-score-p').innerText = "Bạn: " + calculateScore(game.pCap, game.pHand, true);
            document.getElementById('end-score-ai').innerText = "AI: " + calculateScore(game.aiCap, game.aiHand, true);
        }
    }
</script>
</body>
</html>
