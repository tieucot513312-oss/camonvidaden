<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫£m ∆†n V√¨ ƒê√£ ƒê·∫øn</title>
    <style>
        #admin-panel { 
            display: none; 
            background: #1a1a1a; 
            padding: 15px; 
            border-bottom: 3px solid #333; 
        }
        :root { --bg: #0a0a0a; --accent: #f1c40f; --card-w: 72px; --card-h: 100px; --panel-bg: #111; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        #admin-panel { background: #1a1a1a; padding: 15px; border-bottom: 3px solid #333; height: auto; max-height: 90vh; overflow-y: auto; z-index: 1000; position: relative; }
        .admin-grid { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 15px; }
        .box { background: #222; padding: 12px; border-radius: 8px; border: 1px solid #444; }
        .scroll-v { height: 350px; overflow-y: auto; background: #000; padding: 8px; border-radius: 5px; scrollbar-width: thin; }
        .team-item { background: #333; margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 3px solid var(--accent); }
        #game-screen { display: grid; grid-template-columns: 260px 1fr 240px; height: 100vh; background: #050505; }
        .rules-sidebar { background: var(--panel-bg); border-right: 1px solid #333; padding: 15px; overflow-y: auto; font-size: 13px; color: #ddd; line-height: 1.5; scrollbar-width: thin; }
        .rules-sidebar h3 { color: var(--accent); margin-top: 0; text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .play-main { display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; justify-content: center; align-items: center; gap: 15px; }
        .right-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 15px; align-items: center; z-index: 100; }
        .circle-ui { width: 70px; height: 70px; border-radius: 50%; background: #222; border: 3px solid #444; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #timer-val { font-size: 32px; color: var(--accent); }
        .timer-label { font-size: 8px; color: #888; margin-top: -5px; }
        #turn-indicator { font-size: 12px; text-align: center; line-height: 1.2; }
        .p-active { border-color: #2ecc71; color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .ai-active { border-color: #ff4757; color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.3); }
        #draw-pile { width: 75px; height: 105px; border: 2px solid #444; border-radius: 8px; cursor: pointer; background-color: #1a1a1a; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
        #draw-count { font-size: 24px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000; z-index: 2; }
        .play-area { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0; width: 100%; flex: 0 0 auto; }
        .card-row-scroll { display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; overflow-y: hidden; width: 100%; max-width: 650px; padding: 8px 2px; min-height: 115px; scrollbar-width: thin; align-items: center; justify-content: flex-start; margin: 0 auto; }
        .captured-zone { width: 95%; max-width: 650px; display: flex; flex-direction: column; gap: 2px; margin: 0 auto; }
        .captured-list { display: flex; gap: 4px; overflow-x: auto; width: 100%; height: 75px; background: rgba(255,255,255,0.03); border-radius: 5px; padding: 4px; align-items: center; scrollbar-width: thin; }
        .zone-label { font-size: 11px; color: var(--accent); font-weight: bold; margin-left: 5px; display: flex; justify-content: space-between; padding-right: 10px;}
        .card { width: var(--card-w); height: var(--card-h); background: #fff; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 2px solid transparent; flex-shrink: 0; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; } 
        .card .c-img-front { height: 78%; }
        .card .c-name { height: 22%; color: #000; font-size: 9px; font-weight: bold; text-align: center; display: flex; align-items: center; justify-content: center; background: #fff; padding: 0 2px; line-height: 1.1; }
        .card.selected { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
        .card.highlight { border-color: #2ecc71; animation: pulse 1s infinite; }
        .card.team-done { border-color: #ff4757 !important; box-shadow: 0 0 8px #ff4757 !important; }
        .card-mini { width: 45px; height: 64px; border-radius: 4px; flex-shrink: 0; }
        .card-mini .c-name { font-size: 7px; display: flex; height: 25%; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); text-align: center; width: 300px; }
        .side-bar { padding: 10px; background: #111; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scrollbar-width: thin; border-left: 1px solid #222; }
        .team-tag { padding: 5px; border: 1px solid #333; border-radius: 4px; color: #666; font-size: 11px; text-align: center; background: #151515; }
        .team-tag.active { border-color: #ff4757; color: #ff4757; background: rgba(255, 71, 87, 0.1); font-weight: bold; }
        .btn { color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 12px; }
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="decision-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 style="color:var(--accent); margin:0;">B·∫†N R√öT ƒê∆Ø·ª¢C</h3>
        <img id="modal-img" style="width:90px; height:125px; margin:15px auto; border:2px solid white; display:block; object-fit: cover;" src="">
        <div style="display:flex; gap:10px;"><button class="btn" style="background:#2ecc71; flex:1;" onclick="resolveDraw(true)">ƒê√ìN V·ªÄ</button><button class="btn" style="background:#e74c3c; flex:1;" onclick="resolveDraw(false)">T·∫†M XA NHAU</button></div>
    </div>
</div>

<div id="end-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 350px;">
        <h2 style="color:var(--accent); margin-bottom: 20px;">K·∫æT TH√öC V√ÅN ƒê·∫§U</h2>
        <div id="end-score-ai" style="color:#ff4757; font-size: 20px; font-weight: bold; margin-bottom: 10px;"></div>
        <div id="end-score-p" style="color:#2ecc71; font-size: 20px; font-weight: bold; margin-bottom: 10px;"></div>
        <div id="end-winner" style="color:#f1c40f; font-size: 18px; margin: 20px 0; border: 1px dashed #f1c40f; padding: 10px;"></div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#3498db; flex:1; padding: 12px;" onclick="location.reload()">V√ÅN M·ªöI</button>
            <button class="btn" style="background:#7f8c8d; flex:1; padding: 12px;" onclick="hideEndModal()">XEM L·∫†I</button>
        </div>
    </div>
</div>

<div id="pause-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:var(--accent);">‚òï NGH·ªà GI·∫¢I LAO</h2><button class="btn" style="background:#3498db;" onclick="resumeGame()">OK TI·∫æP T·ª§C ‚ñ∂</button></div></div>
<div id="reset-modal" class="modal-overlay hidden"><div class="modal-content"><h2 style="color:#ff4757;">‚ö†Ô∏è C·∫¢NH B√ÅO</h2><p>Ch·∫Øc ch∆∞a?</p><div style="display:flex; gap:10px;"><button class="btn" style="background:#e74c3c; flex:1;" onclick="confirmReset()">CH·∫ÆC R·ªíI</button><button class="btn" style="background:#95a5a6; flex:1;" onclick="closeReset()">TH√îI CH∆†I TI·∫æP</button></div></div></div>

<div id="admin-panel">
    <div style="display:flex; justify-content: space-between; margin-bottom:10px;"><h2 style="color:var(--accent); margin:0;">ADMIN - QU·∫¢N L√ù D·ªÆ LI·ªÜU</h2><button class="btn" style="background:#2ecc71; width:auto;" onclick="startGame()">V√ÄO CH∆†I LU√îN</button></div>
    <div class="admin-grid">
        <div class="box"><strong>1. Link ·∫£nh:</strong><div style="margin-bottom:10px;">M·∫∑t sau: <input type="text" id="back-card-url" oninput="cardBack=this.value;saveData()" style="width:70%; background:#111; color:#fff;"></div><div id="at-album" class="scroll-v" style="height:250px;"></div></div>
        <div class="box"><strong>2. T·∫°o Team:</strong><input type="text" id="t-name" placeholder="T√™n Team..." style="width:90%; margin:5px 0;"><div id="at-checklist" class="scroll-v" style="height:220px;"></div><button class="btn" style="background:#3498db;" onclick="addTeam()">+ L∆ØU NH√ìM</button></div>
        <div class="box"><strong>3. ƒê√£ l∆∞u:</strong><div id="team-list" class="scroll-v"></div></div>
    </div>
</div>

<div id="game-screen" class="hidden">
    <div class="rules-sidebar">
        <h3>LU·∫¨T CH∆†I</h3>
        <b>1. M·ª•c ti√™u:</b> Thu th·∫≠p v√† x·∫øp c√°c l√° b√†i theo ƒë√∫ng team (c√≥ li√™n k·∫øt) ƒë·ªÉ ghi ƒëi·ªÉm<br><br>
        <b>2. Chia b√†i:</b><br>
        - M·ªói ng∆∞·ªùi: 7 l√° b√†i tr√™n tay<br>
        - Gi·ªØa b√†n: 8 l√° b√†i ng·ª≠a<br>
        - Ph·∫ßn c√≤n l·∫°i: b√†i √∫p ƒë·ªÉ r√∫t<br><br>
        <b>3. L∆∞·ª£t ch∆°i & c√°ch l·∫•y b√†i:</b><br>
        - M·ªói l∆∞·ª£t c√≥ 15 gi√¢y<br>
        - To√†n b·ªô c√°c l√° c√πng team (c√≥ li√™n k·∫øt) s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v√†o khu ‚Äúƒê√£ t√¨m th·∫•y nhau‚Äù.<br>
        - H·∫øt b√†i tr√™n tay: b·∫Øt bu·ªôc r√∫t b√†i<br>
        - Ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 trong 2 h√†nh ƒë·ªông:<br>
        * <u>L·∫•y b√†i tr√™n b√†n</u>: N·∫øu b√†i tr√™n tay ho·∫∑c b√†i trong khu ‚Äúƒê√£ t√¨m th·∫•y nhau‚Äù c√≥ li√™n k·∫øt v·ªõi b·∫•t k·ª≥ l√° n√†o tr√™n b√†n -> ƒë∆∞·ª£c l·∫•y l√° ƒë√≥. (B·∫Øt bu·ªôc ph·∫£i c√≥ li√™n k·∫øt m·ªõi ƒë∆∞·ª£c l·∫•y)<br>
        * <u>R√∫t b√†i √∫p</u>: ƒê∆∞·ª£c r√∫t khi kh√¥ng th·ªÉ l·∫•y b√†i tr√™n b√†n ho·∫∑c ch·ªß ƒë·ªông kh√¥ng l·∫•y. Sau khi r√∫t c√≥ th·ªÉ b·ªè qua ho·∫∑c gi·ªØ l·∫°i tr√™n tay.<br><br>
        <b>4. K·∫øt th√∫c & t√≠nh ƒëi·ªÉm:</b><br>
        V√°n k·∫øt th√∫c khi m·ªôt b√™n h·∫øt to√†n b·ªô b√†i ho·∫∑c kh√¥ng th·ªÉ r√∫t/li√™n k·∫øt th√™m.<br>
        - M·ªói li√™n k·∫øt: <b>+1 ƒëi·ªÉm</b><br>
        - ƒê·ªß team: <b>+5 ƒëi·ªÉm</b><br>
        - M·ªói l√° l·∫ª tr√™n tay: <b>-2 ƒëi·ªÉm</b>
    </div>

    <div class="play-main">
        <div class="play-area"><div id="ai-hand" class="card-row-scroll"></div><div class="captured-zone"><div class="zone-label"><span>ƒê√£ t√¨m th·∫•y nhau</span> <span id="score-ai" style="color:#ff4757">0</span></div><div id="ai-captured" class="captured-list"></div></div></div>
        <div class="play-area"><div id="board" class="card-row-scroll"></div></div>
        <div class="play-area"><div class="captured-zone"><div class="zone-label"><span>ƒê√£ t√¨m th·∫•y nhau</span> <span id="score-p" style="color:#2ecc71">0</span></div><div id="p-captured" class="captured-list"></div></div><div id="p-hand" class="card-row-scroll"></div></div>
        <div class="right-controls"><div class="circle-ui"><div id="timer-val">15</div><div class="timer-label">GI√ÇY</div></div><div id="turn-circle" class="circle-ui p-active"><div id="turn-indicator">GAI<br>CON</div></div><div id="draw-pile" onclick="playerDraw()"><span id="draw-count"></span></div></div>
    </div>
<div class="side-bar">
        <div style="text-align:center; margin-bottom: 10px;">
            <h4 style="color:var(--accent); margin:0;">C√ÅC TEAM</h4>
            <small style="color: white; font-size: 10px; opacity: 0.8;">T·ª± √¥n b√†i nh√©!</small>
        </div>

        <div id="side-teams" class="scroll-v" style="height: 400px; margin-bottom: 15px;"></div>        
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn" style="background:#3498db; padding: 12px;" onclick="togglePause()">‚òï T·∫†M D·ª™NG</button>
            <button class="btn" style="background:#9b59b6; padding: 12px;" onclick="resetGame()">üîÑ L√ÄM L·∫†I</button>
        </div>
    </div> </div> ```

### 2. Ki·ªÉm tra l·∫°i Logic JavaScript (Cu·ªëi file)
ƒê·ªÉ Popup hi·ªán l√™n m∆∞·ª£t m√†, h√£y ƒë·∫£m b·∫£o c√°c h√†m ·ªü cu·ªëi th·∫ª `<script>` c·ªßa b·∫°n tr√¥ng nh∆∞ th·∫ø n√†y:

```javascript
// H√†m m·ªü Modal Ngh·ªâ gi·∫£i lao
function togglePause() { 
    isPaused = true; 
    document.getElementById('pause-modal').classList.remove('hidden'); 
}

// H√†m ƒë√≥ng Modal Ngh·ªâ gi·∫£i lao (n√∫t OK Ti·∫øp t·ª•c)
function resumeGame() { 
    isPaused = false; 
    document.getElementById('pause-modal').classList.add('hidden'); 
}

// H√†m m·ªü Modal C·∫£nh b√°o l√†m l·∫°i
function resetGame() { 
    document.getElementById('reset-modal').classList.remove('hidden'); 
}

// H√†m ƒë√≥ng Modal C·∫£nh b√°o (n√∫t Th√¥i ch∆°i ti·∫øp)
function closeReset() { 
    document.getElementById('reset-modal').classList.add('hidden'); 
}

// H√†m x√°c nh·∫≠n reset v√°n m·ªõi
function confirmReset() { 
    document.getElementById('reset-modal').classList.add('hidden'); 
    startGame(); // G·ªçi l·∫°i h√†m b·∫Øt ƒë·∫ßu game
}

<script>
    const AT_NAMES = ["H·ªìng S∆°n","B·∫±ng Ki·ªÅu","T·ª± Long","Phan ƒêinh T√πng","Tu·∫•n H∆∞ng","ƒêinh Ti·∫øn ƒê·∫°t","Ph·∫°m Kh√°nh H∆∞ng","Ti·∫øn Lu·∫≠t","Th√†nh Trung","ƒêƒÉng Kh√¥i","Tr∆∞∆°ng Th·∫ø Vinh","H√† L√™","ƒê·ªó Ho√†ng Hi·ªáp","Thanh Duy","Qu·ªëc Thi√™n","Binz","C∆∞·ªùng Seven","Nguy·ªÖn Tr·∫ßn Duy Nh·∫•t","Jun Ph·∫°m","Neko L√™","TƒÉng Ph√∫c","Thi√™n Minh","BB Tr·∫ßn","Li√™n B·ªânh Ph√°t","S.T S∆°n Th·∫°ch","Rhymastic","Ki√™n ·ª®ng","(S)TRONG Tr·ªçng Hi·∫øu","Soobin Ho√†ng S∆°n","Kay Tr·∫ßn","B√πi C√¥ng Nam","Duy Kh√°nh","HuyR","Anh Tu·∫•n","SLIMV","ƒêinh H√† Uy√™n Th∆∞","Vƒ© Khang","Long Kenji","Kh√°nh Vy","Nh√† ƒêam M√™","Nh√† KK","Nh√† Sao S√°ng","Nh√† T√°i Sinh","Nh√† Ng≈© H√†nh","Nh√† H√°t","Nh√† Xu√¢n H·∫° Thu ƒê√¥ng","Nh√† X∆∞∆°ng R·ªìng","Gai Con","Concert","H·ªèa Ca"];
    let teams = [], at_images = {}, cardBack = "", isPaused = false;
    let game = { pHand:[], aiHand:[], board:[], deck:[], pCap:[], aiCap:[], turn:'p', selected:null, time:15, iv:null, isGameOver: false };
    
    function drive(url) { 
        if(!url || !url.includes('drive.google.com')) return url; 
        let id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0]; 
        return `https://lh3.googleusercontent.com/u/0/d/${id}`;
    }

    window.onload = async () => {
    const localData = localStorage.getItem('at_v23_data');
    if(localData) {
        const d = JSON.parse(localData);
        at_images = d.images || {};
        teams = d.teams || [];
        cardBack = d.cardBack || "";
    }
    try {
        const res = await fetch('./data.json?t=' + Date.now());
        if (res.ok) {
            const data = await res.json();
            if(!cardBack) cardBack = data.cardBack || "";
            if(teams.length === 0) teams = data.teams || [];
            if(Object.keys(at_images).length === 0) at_images = data.images || {};
        }
    } catch (e) { console.log("D√πng d·ªØ li·ªáu Local."); }

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('play') === 'true') {
        startGame();
    } else {
        document.getElementById('admin-panel').style.display = 'block';
        renderAdmin();
    }
};

    function renderAdmin() {
        document.getElementById('back-card-url').value = cardBack;
        document.getElementById('at-album').innerHTML = AT_NAMES.map((n, i) => `<div style="font-size:10px;">${i+1}. ${n} <input type="text" value="${at_images[i+1] || ''}" oninput="at_images[${i+1}]=this.value;saveData()" style="width:60%; background:#111; color:#fff;"></div>`).join('');
        document.getElementById('at-checklist').innerHTML = AT_NAMES.map((n, i) => `<div><input type="checkbox" value="${i+1}" class="chk-at"> ${n}</div>`).join('');
        renderTeamList();
    }

    function addTeam() {
        const name = document.getElementById('t-name').value;
        const checkboxes = document.querySelectorAll('.chk-at:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
        if(!name || ids.length < 2) return;
        teams.push({ name, members: ids });
        renderTeamList(); saveData();
        document.getElementById('t-name').value = "";
        checkboxes.forEach(cb => cb.checked = false);
    }

    function renderTeamList() { 
        document.getElementById('team-list').innerHTML = teams.map((t, i) => `<div class="team-item"><strong>${t.name}</strong><span onclick="teams.splice(${i},1);renderTeamList();saveData()" style="color:#ff4757; float:right; cursor:pointer;">X</span><div style="font-size:10px; color:#aaa; margin-top:4px;">${t.members.map(m => AT_NAMES[m-1]).join(', ')}</div></div>`).join('');
    }

    function saveData() { localStorage.setItem('at_v23_data', JSON.stringify({ images: at_images, teams: teams, cardBack: cardBack })); }

    function startGame() {
        document.getElementById('admin-panel').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        let fullDeck = AT_NAMES.map((n, i) => ({ id: i+1, name: n, img: drive(at_images[i+1]) }));
        for (let i = fullDeck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [fullDeck[i], fullDeck[j]] = [fullDeck[j], fullDeck[i]];
        }
        game.pHand = fullDeck.splice(0, 7); game.aiHand = fullDeck.splice(0, 7);
        game.board = fullDeck.splice(0, 8); game.deck = fullDeck;
        game.pCap = []; game.aiCap = []; game.turn = 'p';
        game.isGameOver = false;
        document.getElementById('side-teams').innerHTML = teams.map(t => `<div id="tag-${t.name.replace(/\s/g,'')}" class="team-tag">${t.name}</div>`).join('');
        updateUI(); startTimer();
    }

    function calculateScore(captured, hand, isFinal = false) {
        let s = captured.length;
        teams.forEach(t => { if(t.members.every(mId => captured.some(c => c.id === mId))) s += 5; });
        if(isFinal) { s -= (hand.length * 2); }
        return s;
    }

    function updateUI() {
        document.getElementById('score-p').innerText = calculateScore(game.pCap, game.pHand);
        document.getElementById('score-ai').innerText = calculateScore(game.aiCap, game.aiHand);
        const tc = document.getElementById('turn-circle');
        document.getElementById('turn-indicator').innerHTML = game.turn === 'p' ? "GAI<br>CON" : "ANH<br>T√ÄI";
        tc.className = game.turn === 'p' ? "circle-ui p-active" : "circle-ui ai-active";
        document.getElementById('draw-count').innerText = game.deck.length;
        if(cardBack) document.getElementById('draw-pile').style.backgroundImage = `url('${drive(cardBack)}')`;

        const cardH = (c, isP) => `<div class="card ${game.selected === c.id ? 'selected' : ''}" onclick="${isP ? `selectCard(${c.id})` : ''}"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        
        // Logic l·∫≠t b√†i AI khi game over
        document.getElementById('ai-hand').innerHTML = game.aiHand.map(c => {
            if (game.isGameOver) {
                return `<div class="card"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
            } else {
                return cardBack ? `<div class="card"><img src="${drive(cardBack)}"></div>` : `<div class="card" style="background:#222;"></div>`;
            }
        }).join('');
        
        document.getElementById('p-hand').innerHTML = game.pHand.map(c => cardH(c, true)).join('');
        
        document.getElementById('board').innerHTML = game.board.map(c => {
            const linkWithSelected = game.selected && teams.some(t => t.members.includes(game.selected) && t.members.includes(c.id));
            const linkWithCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
            const isHighlight = (game.turn === 'p' && (linkWithSelected || linkWithCap));
            return `<div class="card ${isHighlight ? 'highlight' : ''}" onclick="takeCard(${c.id})"><img class="c-img-front" src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        }).join('');

        const mini = (c, ownerCap) => {
            const myTeam = teams.find(t => t.members.includes(c.id));
            const isDone = myTeam && myTeam.members.every(mId => ownerCap.some(oc => oc.id === mId));
            return `<div class="card card-mini ${isDone ? 'team-done' : ''}"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
        };
        document.getElementById('p-captured').innerHTML = renderCapturedSorted(game.pCap);
        document.getElementById('ai-captured').innerHTML = renderCapturedSorted(game.aiCap);
        
        teams.forEach(t => { 
            const ok = t.members.every(mId => game.pCap.some(c => c.id === mId)) || t.members.every(mId => game.aiCap.some(c => c.id === mId)); 
            const el = document.getElementById(`tag-${t.name.replace(/\s/g,'')}`); 
            if(el) el.className = ok ? 'team-tag active' : 'team-tag'; 
        });
        
        // G·ªçi checkEndGame cu·ªëi c√πng
        checkEndGame();
    }

    function selectCard(id) { if(game.turn === 'p') { game.selected = (game.selected === id) ? null : id; updateUI(); } }

    function takeCard(bId) {
        if(game.turn !== 'p' || isPaused) return;
        const bc = game.board.find(x => x.id === bId);
        const mMatchCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(bId)));
        if(mMatchCap) { game.pCap.push(bc); game.board = game.board.filter(x => x.id !== bId); nextTurn(); return; }
        if(game.selected) { 
            const matchHand = teams.some(t => t.members.includes(game.selected) && t.members.includes(bId));
            if(matchHand) { 
                game.pCap.push(bc, game.pHand.find(x => x.id === game.selected)); 
                game.board = game.board.filter(x => x.id !== bId);
                game.pHand = game.pHand.filter(x => x.id !== game.selected); 
                game.selected = null; nextTurn(); 
            } 
        }
    }
// --- THAY TH·∫æ T·ª™ ƒê√ÇY ---

function renderCapturedSorted(capList) {
    if (!capList || capList.length === 0) return "";

    // 1. T·∫°o b·∫£n sao ƒë·ªÉ s·∫Øp x·∫øp
    let sortedList = [...capList];

    // 2. S·∫Øp x·∫øp: C√°c l√° c√πng Team ƒë·ª©ng c·∫°nh nhau
    sortedList.sort((a, b) => {
        const teamA = teams.findIndex(t => t.members.includes(a.id));
        const teamB = teams.findIndex(t => t.members.includes(b.id));
        return teamA - teamB;
    });

    // 3. Tr·∫£ v·ªÅ HTML ph·∫≥ng (Gi√∫p b√†i n·∫±m tr√™n 1 h√†ng ngang)
    return sortedList.map(c => {
        const myTeam = teams.find(t => t.members.includes(c.id));
        const isDone = myTeam && myTeam.members.every(mId => capList.some(oc => oc.id === mId));
        return `<div class="card card-mini ${isDone ? 'team-done' : ''}"><img src="${c.img}"><div class="c-name">${c.name}</div></div>`;
    }).join('');
}

function playerDraw() { 
    if(game.turn !== 'p' || isPaused || game.deck.length === 0) return;
    game.tempDraw = game.deck.shift(); 
    document.getElementById('decision-modal').classList.remove('hidden'); 
    document.getElementById('modal-img').src = game.tempDraw.img; 
}

function resolveDraw(isK) { 
    document.getElementById('decision-modal').classList.add('hidden'); 
    let c = game.tempDraw;
    if(isK) { 
        let inCap = game.pCap.some(pc => teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id)));
        let inHandMatch = game.pHand.find(ph => teams.some(t => t.members.includes(ph.id) && t.members.includes(c.id)));
        if (inCap) { game.pCap.push(c); } 
        else if (inHandMatch) { game.pCap.push(c, inHandMatch); game.pHand = game.pHand.filter(x => x.id !== inHandMatch.id); } 
        else { game.pHand.push(c); }
    } else { game.board.push(c); } 
    game.tempDraw = null; nextTurn(); 
}

function startTimer() { 
    clearInterval(game.iv);
    if (game.isGameOver) return;
    game.time = 15; document.getElementById('timer-val').innerText = game.time;
    game.iv = setInterval(() => { 
        if(!isPaused) { 
            game.time--; 
            document.getElementById('timer-val').innerText = game.time; 
            if(game.turn === 'ai' && game.time === 7) aiMove(); 
            if(game.time <= 0) nextTurn(); 
        } 
    }, 1000);
}

function nextTurn() { 
    if(game.tempDraw) { 
        game.board.push(game.tempDraw); 
        game.tempDraw = null; 
        document.getElementById('decision-modal').classList.add('hidden'); 
    }
    game.turn = (game.turn === 'p' ? 'ai' : 'p'); 
    updateUI(); 
    startTimer(); 
}

function aiMove() {
    if (isPaused) return;
    let acted = false;

    for (let ah of game.aiHand) {
        let target = game.board.find(bc => teams.some(t => t.members.includes(ah.id) && t.members.includes(bc.id)));
        if (target) {
            game.aiCap.push(ah, target);
            game.aiHand = game.aiHand.filter(x => x.id !== ah.id);
            game.board = game.board.filter(x => x.id !== target.id);
            acted = true;
            break;
        }
    }
    if (!acted) {
        let target = game.board.find(bc => game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(bc.id))));
        if (target) {
            game.aiCap.push(target);
            game.board = game.board.filter(x => x.id !== target.id);
            acted = true;
        }
    }

    if (!acted && game.deck.length > 0) {
        let c = game.deck.shift(); 
        let linkCap = game.aiCap.some(ac => teams.some(t => t.members.includes(ac.id) && t.members.includes(c.id)));
        if (linkCap) {
            game.aiCap.push(c);
        } else {
            let linkHand = game.aiHand.find(ah => teams.some(t => t.members.includes(ah.id) && t.members.includes(c.id)));
            if (linkHand) {
                game.aiCap.push(c, linkHand);
                game.aiHand = game.aiHand.filter(x => x.id !== linkHand.id);
            } else {
                let linkBoard = game.board.some(b => teams.some(t => t.members.includes(b.id) && t.members.includes(c.id)));
                if (linkBoard) { game.aiHand.push(c); } 
                else { game.board.push(c); }
            }
        }
        acted = true;
    }
    nextTurn();
}

function autoMoveToEnd(playerHand, playerCap) {
    let changed = true;
    while (changed) {
        changed = false;
        for (let i = 0; i < playerHand.length; i++) {
            let c = playerHand[i];
            let hasLink = playerCap.some(pc => 
                teams.some(t => t.members.includes(pc.id) && t.members.includes(c.id))
            );
            if (hasLink) {
                playerCap.push(c);
                playerHand.splice(i, 1);
                i--;
                changed = true;
            }
        }
        if (!changed) {
            for (let i = 0; i < playerHand.length; i++) {
                for (let j = i + 1; j < playerHand.length; j++) {
                    let isTeam = teams.some(t => 
                        t.members.includes(playerHand[i].id) && t.members.includes(playerHand[j].id)
                    );
                    if (isTeam) {
                        playerCap.push(playerHand[i], playerHand[j]);
                        playerHand.splice(j, 1); 
                        playerHand.splice(i, 1);
                        changed = true;
                        break; 
                    }
                }
                if (changed) break;
            }
        }
    }
}

// --- H·∫æT ƒêO·∫†N THAY TH·∫æ ---
    
    function hasPossibleMove(hand, cap) {
        const handMatch = hand.some(h => game.board.some(b => teams.some(t => t.members.includes(h.id) && t.members.includes(b.id))));
        const capMatch = game.board.some(b => cap.some(c => teams.some(t => t.members.includes(c.id) && t.members.includes(b.id))));
        return handMatch || capMatch;
    }

    function checkEndGame() { 
        // QUAN TR·ªåNG: NgƒÉn ch·∫∑n v√≤ng l·∫∑p v√¥ t·∫≠n
        if (game.isGameOver) return;

        const noMovesLeft = game.deck.length === 0 && !hasPossibleMove(game.pHand, game.pCap) && !hasPossibleMove(game.aiHand, game.aiCap);

        if((game.board.length === 0 && game.deck.length === 0) || 
           (game.deck.length === 0 && (game.pHand.length === 0 || game.aiHand.length === 0)) ||
           noMovesLeft) { 
            
            clearInterval(game.iv);
            game.isGameOver = true; // ƒê√°nh d·∫•u game over ngay l·∫≠p t·ª©c
            autoMoveToEnd(game.pHand, game.pCap);
            autoMoveToEnd(game.aiHand, game.aiCap);
            
            updateUI(); // G·ªçi updateUI 1 l·∫ßn cu·ªëi ƒë·ªÉ l·∫≠t b√†i (nh·ªù d√≤ng check ·ªü ƒë·∫ßu h√†m n√†y m√† n√≥ s·∫Ω kh√¥ng l·∫∑p l·∫°i)
            
            let pF = calculateScore(game.pCap, game.pHand, true);
            let aF = calculateScore(game.aiCap, game.aiHand, true);
            showEndPopup(pF, aF);
        } 
    }

    function showEndPopup(pScore, aiScore) {
        const modal = document.getElementById('end-modal');
        document.getElementById('end-score-ai').innerText = `Anh T√†i: ${aiScore}`;
        document.getElementById('end-score-p').innerText = `Gai Con: ${pScore}`;
        let winner = pScore > aiScore ? "Gai Con" : (aiScore > pScore ? "Anh T√†i" : "H√≤a nhau");
        document.getElementById('end-winner').innerText = `Ch√∫c m·ª´ng ng∆∞·ªùi chi·∫øn th·∫Øng l√† ${winner}`;
        modal.classList.remove('hidden');
    }
    function hideEndModal() {
    document.getElementById('end-modal').classList.add('hidden');
}
    function togglePause() { isPaused = true; document.getElementById('pause-modal').classList.remove('hidden'); }
    function resumeGame() { isPaused = false; document.getElementById('pause-modal').classList.add('hidden'); }
    function resetGame() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function confirmReset() { document.getElementById('reset-modal').classList.add('hidden'); startGame(); }
    function closeReset() { document.getElementById('reset-modal').classList.add('hidden'); }
</script>
</body>
</html>







